{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Profile - SoundCloud Download Gating By BandPass Records{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-user-edit"></i> Edit Profile
                    </h1>
                    <p class="text-muted mb-0">Update your profile information and preferences</p>
                </div>
                <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Profile
                </a>
            </div>
            
            <!-- Edit Profile Form -->
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user"></i> Profile Information
                    </h5>
                </div>
                
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Basic User Information -->
                        <div class="row">
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ user_form.email.id_for_label }}" class="form-label">
                                        <i class="fas fa-envelope"></i> Email
                                    </label>
                                    {{ user_form.email }}
                                    <div class="form-text">
                                        <i class="fas fa-info-circle"></i> Email cannot be changed. Contact support if you need to update your email address.
                                    </div>
                                    {% if user_form.email.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ user_form.email.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ user_form.first_name.id_for_label }}" class="form-label">
                                        <i class="fas fa-user"></i> First Name
                                    </label>
                                    {{ user_form.first_name }}
                                    {% if user_form.first_name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ user_form.first_name.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ user_form.last_name.id_for_label }}" class="form-label">
                                        <i class="fas fa-user"></i> Last Name
                                    </label>
                                    {{ user_form.last_name }}
                                    {% if user_form.last_name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ user_form.last_name.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- Profile Avatar -->
                        <div class="mb-4">
                            <label class="form-label mb-3">
                                <i class="fas fa-image"></i> Profile Picture
                            </label>
                            
                            <div class="avatar-upload-container">
                                <div class="avatar-preview-wrapper">
                                    <div class="avatar-preview" id="avatarPreview">
                                        {% if user.profile.avatar %}
                                            <img src="{{ user.profile.avatar.url }}" alt="Current Avatar" id="avatarImage" class="avatar-preview-img">
                                        {% else %}
                                            <div class="avatar-preview-placeholder">
                                                <i class="fas fa-user fa-3x"></i>
                                            </div>
                                        {% endif %}
                                        <div class="avatar-preview-overlay">
                                            <i class="fas fa-camera fa-2x"></i>
                                            <span class="mt-2">Change Photo</span>
                                        </div>
                                    </div>
                                    {% if user.profile.avatar %}
                                    <div class="avatar-actions mt-3">
                                        <button type="button" class="btn btn-sm btn-outline-danger w-100" id="removeAvatarBtn" data-bs-toggle="modal" data-bs-target="#removeAvatarModal">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="avatar-upload-area" id="avatarUploadArea">
                                    <div class="avatar-upload-content">
                                        <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                                        <p class="mb-1"><strong>Click to browse</strong> or drag and drop</p>
                                        <p class="small text-muted mb-0">PNG, JPG or GIF (max. 5MB)</p>
                                    </div>
                                    <input type="file" name="{{ profile_form.avatar.name }}" id="{{ profile_form.avatar.id_for_label }}" 
                                           accept="image/*" class="avatar-file-input" style="display: none;">
                                </div>
                                
                                {% if profile_form.avatar.errors %}
                                    <div class="invalid-feedback d-block mt-2">
                                        {{ profile_form.avatar.errors }}
                                    </div>
                                {% endif %}
                                {% if profile_form.avatar.help_text %}
                                    <div class="form-text mt-2">{{ profile_form.avatar.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Bio -->
                        <div class="mb-3">
                            <label for="{{ profile_form.bio.id_for_label }}" class="form-label">
                                <i class="fas fa-align-left"></i> Bio
                            </label>
                            {{ profile_form.bio }}
                            {% if profile_form.bio.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ profile_form.bio.errors }}
                                </div>
                            {% endif %}
                            {% if profile_form.bio.help_text %}
                                <div class="form-text">{{ profile_form.bio.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- Privacy Settings -->
                        <h6 class="mb-3">
                            <i class="fas fa-shield-alt"></i> Privacy Settings
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    {{ profile_form.show_email }}
                                    <label class="form-check-label" for="{{ profile_form.show_email.id_for_label }}">
                                        Show email in public profile
                                    </label>
                                </div>
                                
                                <div class="form-check mb-3">
                                    {% if user.first_name and user.last_name %}
                                        {{ profile_form.show_real_name }}
                                        <label class="form-check-label" for="{{ profile_form.show_real_name.id_for_label }}">
                                            Show real name in public profile
                                        </label>
                                        {% if profile_form.show_real_name.help_text %}
                                            <div class="form-text">{{ profile_form.show_real_name.help_text }}</div>
                                        {% endif %}
                                    {% else %}
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> 
                                            <strong>Show Real Name:</strong> To use this option, please set your first name and surname in the "Basic User Information" section above.
                                        </div>
                                    {% endif %}
                                    {% if profile_form.show_real_name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ profile_form.show_real_name.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between pt-3">
                            <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Password Change Section -->
            <div class="card mt-4">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-key"></i> Change Password
                    </h6>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        To change your password, use the link below. You'll receive an email with instructions.
                    </p>
                    
                    <a href="{% url 'accounts:password_reset' %}" class="btn btn-outline-warning">
                        <i class="fas fa-key"></i> Change Password
                    </a>
                </div>
            </div>
            
            <!-- Delete Account Section -->
            <div class="card mt-4 border-danger">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Danger Zone
                    </h6>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        <strong>Warning:</strong> Deleting your account is permanent and cannot be undone. 
                        This will remove all your data, including your macros, profile, and account information.
                    </p>
                    
                    <a href="{% url 'accounts:delete_account' %}" class="btn btn-outline-danger">
                        <i class="fas fa-trash-alt"></i> Delete Account
                    </a>
                </div>
            </div>
            
        </div>
    </div>
</div>

<!-- Remove Avatar Confirmation Modal -->
<div class="modal fade" id="removeAvatarModal" tabindex="-1" aria-labelledby="removeAvatarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="removeAvatarModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>Remove Profile Picture
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Are you sure you want to remove your profile picture? This action cannot be undone.</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmRemoveAvatarBtn">
                    <i class="fas fa-trash"></i> Remove
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.avatar-upload-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
}

.avatar-preview-wrapper {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.avatar-preview {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    overflow: hidden;
    position: relative;
    border: 3px solid var(--border-color);
    background: var(--bg-card);
    cursor: pointer;
    transition: all 0.3s ease;
}

.avatar-preview:hover {
    border-color: var(--primary-color);
    transform: scale(1.05);
}

.avatar-preview-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-preview-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-tertiary);
    color: var(--text-muted);
}

.avatar-preview-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    opacity: 0;
    transition: opacity 0.3s ease;
    border-radius: 50%;
}

.avatar-preview:hover .avatar-preview-overlay {
    opacity: 1;
}

.avatar-upload-area {
    width: 100%;
    max-width: 400px;
    min-height: 120px;
    border: 2px dashed var(--border-color);
    border-radius: 0.75rem;
    padding: 2rem;
    text-align: center;
    background: var(--bg-card);
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.avatar-upload-area:hover {
    border-color: var(--primary-color);
    background: var(--bg-card-hover);
}

.avatar-upload-area.dragover {
    border-color: var(--primary-color);
    background: rgba(59, 130, 246, 0.1);
    transform: scale(1.02);
}

.avatar-upload-content {
    pointer-events: none;
    color: var(--text-secondary);
}

.avatar-upload-content i {
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}

.avatar-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
}

.form-check-label {
    cursor: pointer;
}

.card {
    transition: box-shadow 0.2s ease-in-out;
}

.card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

@media (min-width: 768px) {
    .avatar-upload-container {
        flex-direction: row;
        align-items: flex-start;
    }
    
    .avatar-upload-area {
        flex: 1;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const avatarInput = document.getElementById('{{ profile_form.avatar.id_for_label }}');
    const avatarPreview = document.getElementById('avatarPreview');
    const avatarUploadArea = document.getElementById('avatarUploadArea');
    const removeBtn = document.getElementById('removeAvatarBtn');
    
    // Click handlers - clicking preview or upload area opens file dialog
    if (avatarPreview && avatarInput) {
        avatarPreview.addEventListener('click', function() {
            avatarInput.click();
        });
    }
    
    if (avatarUploadArea && avatarInput) {
        avatarUploadArea.addEventListener('click', function() {
            avatarInput.click();
        });
    }
    
    // Remove avatar button - handled by modal
    const confirmRemoveBtn = document.getElementById('confirmRemoveAvatarBtn');
    if (confirmRemoveBtn) {
        confirmRemoveBtn.addEventListener('click', function() {
            // Create a hidden input to indicate removal
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'avatar-clear';
            hiddenInput.value = '1';
            avatarInput.form.appendChild(hiddenInput);
            
            // Reset preview
            const placeholder = document.createElement('div');
            placeholder.className = 'avatar-preview-placeholder';
            placeholder.innerHTML = '<i class="fas fa-user fa-3x"></i>';
            avatarPreview.innerHTML = '';
            avatarPreview.appendChild(placeholder);
            
            // Clear file input
            avatarInput.value = '';
            
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('removeAvatarModal'));
            if (modal) {
                modal.hide();
            }
            
            // Remove the remove button since there's no avatar anymore
            const removeBtnContainer = document.querySelector('.avatar-actions');
            if (removeBtnContainer) {
                removeBtnContainer.remove();
            }
        });
    }
    
    // File input change handler
    if (avatarInput) {
        avatarInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    if (window.showToast) {
                        showToast('Please select an image file.', 'error');
                    }
                    avatarInput.value = '';
                    return;
                }
                
                // Validate file size (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    if (window.showToast) {
                        showToast('File size must be less than 5MB.', 'error');
                    }
                    avatarInput.value = '';
                    return;
                }
                
                // Preview image
                const reader = new FileReader();
                reader.onload = function(e) {
                    let img = avatarPreview.querySelector('.avatar-preview-img');
                    if (!img) {
                        // Remove placeholder if exists
                        const placeholder = avatarPreview.querySelector('.avatar-preview-placeholder');
                        if (placeholder) {
                            placeholder.remove();
                        }
                        
                        // Create new image element
                        img = document.createElement('img');
                        img.className = 'avatar-preview-img';
                        img.alt = 'Avatar Preview';
                        avatarPreview.appendChild(img);
                        
                        // Add overlay
                        const overlay = document.createElement('div');
                        overlay.className = 'avatar-preview-overlay';
                        overlay.innerHTML = '<i class="fas fa-camera fa-2x"></i><span class="mt-2">Change Photo</span>';
                        avatarPreview.appendChild(overlay);
                    }
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Drag and drop handlers
    if (avatarUploadArea) {
        let dragCounter = 0;
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            avatarUploadArea.addEventListener(eventName, function(e) {
                e.preventDefault();
                e.stopPropagation();
            });
        });
        
        avatarUploadArea.addEventListener('dragenter', function() {
            dragCounter++;
            avatarUploadArea.classList.add('dragover');
        });
        
        avatarUploadArea.addEventListener('dragleave', function() {
            dragCounter--;
            if (dragCounter === 0) {
                avatarUploadArea.classList.remove('dragover');
            }
        });
        
        avatarUploadArea.addEventListener('drop', function(e) {
            dragCounter = 0;
            avatarUploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && avatarInput) {
                avatarInput.files = files;
                // Trigger change event
                const event = new Event('change', { bubbles: true });
                avatarInput.dispatchEvent(event);
            }
        });
    }
});
</script>
{% endblock %} 